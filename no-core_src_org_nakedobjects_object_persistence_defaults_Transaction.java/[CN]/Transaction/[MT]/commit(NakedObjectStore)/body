{
  LOG.info("commit transaction " + this);
  if (complete) {
    throw new TransactionException("Transaction already complete; cannot commit");
  }
  complete=true;
  PersistenceCommand[] commandsArray=new PersistenceCommand[commands.size()];
  commands.copyInto(commandsArray);
  if (commandsArray.length > 0) {
    objectStore.startTransaction();
    try {
      objectStore.runTransaction(commandsArray);
      objectStore.endTransaction();
      PojoAdapterFactory loaded=NakedObjects.getPojoAdapterFactory();
      for (int i=0; i < commandsArray.length; i++) {
        PersistenceCommand command=commandsArray[i];
        if (command instanceof CreateObjectCommand) {
          NakedObject object;
          object=command.onObject();
          loaded.loaded(object);
        }
 else         if (command instanceof DestroyObjectCommand) {
          NakedObject object=command.onObject();
          loaded.unloaded(object);
        }
      }
    }
 catch (    ObjectStoreException e) {
      objectStore.abortTransaction();
      throw e;
    }
  }
}
