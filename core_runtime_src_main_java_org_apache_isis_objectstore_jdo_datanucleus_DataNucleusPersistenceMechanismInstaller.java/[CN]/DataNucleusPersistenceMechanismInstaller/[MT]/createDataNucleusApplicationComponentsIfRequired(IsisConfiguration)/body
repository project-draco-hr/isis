{
  if (applicationComponents == null || applicationComponents.isStale()) {
    final IsisConfiguration jdoObjectstoreConfig=configuration.createSubset(JDO_OBJECTSTORE_CONFIG_PREFIX);
    final IsisConfiguration dataNucleusConfig=configuration.createSubset(DATANUCLEUS_CONFIG_PREFIX);
    final Map<String,String> datanucleusProps=dataNucleusConfig.asMap();
    addDataNucleusPropertiesIfRequired(datanucleusProps);
    final Set<String> classesToBePersisted=catalogClassesToBePersisted(configuration,getSpecificationLoader().allSpecifications());
    applicationComponents=new DataNucleusApplicationComponents(jdoObjectstoreConfig,datanucleusProps,classesToBePersisted);
  }
  return applicationComponents;
}
