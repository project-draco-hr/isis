{
  final ObjectSpecification specification=query.getSpecification();
  final DatabaseConnector connector=connectionPool.acquire();
  final Vector<ObjectAdapter> matchingInstances=new Vector<ObjectAdapter>();
  if (!specification.isAbstract()) {
    addSpecQueryInstances(specification,connector,query,matchingInstances);
  }
  if (specification.hasSubclasses()) {
    final List<ObjectSpecification> subclasses=specification.subclasses();
    for (    ObjectSpecification subclassSpec : subclasses) {
      addSpecQueryInstances(subclassSpec,connector,query,matchingInstances);
    }
  }
  connectionPool.release(connector);
  final ObjectAdapter[] instanceArray=new ObjectAdapter[matchingInstances.size()];
  matchingInstances.copyInto(instanceArray);
  return instanceArray;
}
