{
  if (savedObject.contains(object)) {
    return null;
  }
  savedObject.add(object);
  final JSONObject data=new JSONObject();
  final ObjectSpecification specification=object.getSpecification();
  data.put("_class",specification.getFullIdentifier());
  final Oid oid=object.getOid();
  String encodedOid;
  if (oid instanceof AggregatedOid) {
    final AggregatedOid aoid=(AggregatedOid)oid;
    final Oid parentOid=aoid.getParentOid();
    final String aggregatedId=aoid.getId();
    encodedOid=Long.toString(((SerialOid)parentOid).getSerialNo(),16) + "@" + aggregatedId;
  }
 else   if (oid instanceof SerialOid) {
    encodedOid=Long.toString(((SerialOid)oid).getSerialNo(),16);
  }
 else {
    throw new ScimpiException("Unsupportred OID type " + oid);
  }
  data.put("_id",encodedOid);
  for (  final ObjectAssociation association : specification.getAssociations()) {
    final ObjectAdapter fieldValue=association.get(object);
    final String fieldName=association.getId();
    if (fieldValue == null) {
      data.put(fieldName,(Object)null);
    }
 else     if (association.getSpecification().isEncodeable()) {
      final EncodableFacet encodeableFacet=fieldValue.getSpecification().getFacet(EncodableFacet.class);
      data.put(fieldName,encodeableFacet.toEncodedString(fieldValue));
    }
 else     if (association instanceof OneToManyAssociation) {
      final List<JSONObject> collection=new ArrayList<JSONObject>();
      final CollectionFacet facet=fieldValue.getSpecification().getFacet(CollectionFacet.class);
      for (      final ObjectAdapter element : facet.iterable(fieldValue)) {
        collection.add(encodeTransientData(element,savedObject));
      }
      data.put(fieldName,collection);
    }
 else {
      if (fieldValue.isTransient() || fieldValue.isAggregated()) {
        final JSONObject saveData=encodeTransientData(fieldValue,savedObject);
        if (saveData == null) {
          data.put(fieldName,mapObject(fieldValue,Scope.INTERACTION));
        }
 else {
          data.put(fieldName,saveData);
        }
      }
 else {
        data.put(fieldName,mapObject(fieldValue,Scope.INTERACTION));
      }
    }
  }
  return data;
}
