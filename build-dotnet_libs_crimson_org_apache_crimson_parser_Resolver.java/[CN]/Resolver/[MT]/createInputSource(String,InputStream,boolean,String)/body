{
  InputSource retval;
  String charset=null;
  if (contentType != null) {
    int index;
    contentType=contentType.toLowerCase();
    index=contentType.indexOf(';');
    if (index != -1) {
      String attributes;
      attributes=contentType.substring(index + 1);
      contentType=contentType.substring(0,index);
      index=attributes.indexOf("charset");
      if (index != -1) {
        attributes=attributes.substring(index + 7);
        if ((index=attributes.indexOf(';')) != -1)         attributes=attributes.substring(0,index);
        if ((index=attributes.indexOf('=')) != -1) {
          attributes=attributes.substring(index + 1);
          if ((index=attributes.indexOf('(')) != -1)           attributes=attributes.substring(0,index);
          if ((index=attributes.indexOf('"')) != -1) {
            attributes=attributes.substring(index + 1);
            attributes=attributes.substring(0,attributes.indexOf('"'));
          }
          charset=attributes.trim();
        }
      }
    }
    if (checkType) {
      boolean isOK=false;
      for (int i=0; i < types.length; i++)       if (types[i].equals(contentType)) {
        isOK=true;
        break;
      }
      if (!isOK)       throw new IOException("Not XML: " + contentType);
    }
    if (charset == null) {
      contentType=contentType.trim();
      if (contentType.startsWith("text/")) {
        if (!"file".equalsIgnoreCase(scheme))         charset="US-ASCII";
      }
    }
  }
  retval=new InputSource(XmlReader.createReader(stream,charset));
  retval.setByteStream(stream);
  retval.setEncoding(charset);
  return retval;
}
