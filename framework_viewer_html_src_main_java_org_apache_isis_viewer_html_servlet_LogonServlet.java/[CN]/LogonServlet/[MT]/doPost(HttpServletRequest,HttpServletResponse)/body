{
  AuthenticationSession authSession=new AuthenticationSessionLookupStrategyDefault().lookup(request,response);
  if (authSession != null) {
    final boolean sessionValid=IsisContext.getAuthenticationManager().isSessionValid(authSession);
    if (sessionValid) {
      loggedIn(response,authSession.getUserName());
      return;
    }
  }
  final String user=request.getParameter("username");
  final String password=request.getParameter("password");
  if (user == null && !IsisContext.getDeploymentType().isExploring()) {
    prompt(response,"","","");
    return;
  }
  authSession=authenticate(user,password);
  if (authSession == null) {
    prompt(response,user,password,"error");
    return;
  }
  final HttpSession httpSession=request.getSession(true);
  httpSession.setAttribute(WebAppConstants.HTTP_SESSION_AUTHENTICATION_SESSION_KEY,authSession);
  final Context context=new Context(new HtmlComponentFactory());
  context.setSession(authSession);
  authSession.setAttribute(HtmlServletConstants.AUTHENTICATION_SESSION_CONTEXT_KEY,context);
  LOG.info("created session: " + httpSession);
  loggedIn(response,user);
}
