{
  final ActionPrompt actionPrompt=actionPromptProvider.getActionPrompt();
  if (actionPrompt != null) {
    final ActionModel actionModel=ActionModel.create(objectAdapter,action);
    actionModel.setActionPrompt(actionPrompt);
    final AjaxDeferredBehaviour ajaxDeferredBehaviour=determineDeferredBehaviour(action,actionModel);
    final AbstractLink link=new AjaxLink<Object>(linkId){
      private static final long serialVersionUID=1L;
      @Override public void onClick(      AjaxRequestTarget target){
        if (ajaxDeferredBehaviour != null) {
          ajaxDeferredBehaviour.initiate(target);
        }
 else {
          final ActionPanel actionPanel=(ActionPanel)getComponentFactoryRegistry().createComponent(ComponentType.ACTION_PROMPT,actionPrompt.getContentId(),actionModel);
          actionPrompt.setPanel(actionPanel,target);
          actionPanel.setActionPrompt(actionPrompt);
          actionPrompt.showPrompt(target);
          focusOnFirstParameter(target,actionPanel);
        }
      }
      private void focusOnFirstParameter(      AjaxRequestTarget target,      ActionPanel actionPanel){
        actionPanel.visitChildren(new IVisitor<Component,Component>(){
          @Override public void component(          Component object,          IVisit<Component> visit){
            if (object instanceof ScalarPanelAbstract) {
              ScalarPanelAbstract spa=(ScalarPanelAbstract)object;
              spa.forceBuildGui();
              visit.dontGoDeeper();
            }
          }
        }
);
        final Component actionPanelFirstParam=actionPanel.visitChildren(new IVisitor<Component,Component>(){
          @Override public void component(          Component object,          IVisit<Component> visit){
            if (object instanceof FormComponent && !"scalarIfCompact".equals(object.getId()) && object.getOutputMarkupId()) {
              visit.stop(object);
            }
          }
        }
);
        if (actionPanelFirstParam != null) {
          target.focusComponent(actionPanelFirstParam);
        }
      }
      @Override protected void updateAjaxAttributes(      AjaxRequestAttributes attributes){
        super.updateAjaxAttributes(attributes);
        attributes.setEventPropagation(AjaxRequestAttributes.EventPropagation.BUBBLE);
      }
    }
;
    if (ajaxDeferredBehaviour != null) {
      link.add(ajaxDeferredBehaviour);
    }
    link.add(new CssClassAppender("noVeil"));
    return link;
  }
 else {
    final ConcurrencyChecking concurrencyChecking=ConcurrencyChecking.concurrencyCheckingFor(action.getSemantics());
    final PageParameters pageParameters=ActionModel.createPageParameters(objectAdapter,action,concurrencyChecking);
    final Class<? extends Page> pageClass=getPageClassRegistry().getPageClass(PageType.ACTION_PROMPT);
    AbstractLink link=Links.newBookmarkablePageLink(linkId,pageParameters,pageClass);
    if (action.getParameterCount() == 0) {
      addTargetBlankIfActionReturnsUrl(link,action);
    }
    return link;
  }
}
