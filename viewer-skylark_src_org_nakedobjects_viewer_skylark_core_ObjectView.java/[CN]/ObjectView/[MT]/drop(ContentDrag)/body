{
  Assert.assertTrue(drag.getSourceContent() instanceof ObjectContent);
  NakedObject source=((ObjectContent)drag.getSourceContent()).getObject();
  Assert.assertNotNull(source);
  NakedObject target=(NakedObject)getObject();
  Assert.assertNotNull(target);
  if (canDrop(source,target).isAllowed()) {
    Action action=dropAction(source,target);
    if ((action != null) && target.getHint(ClientSession.getSession(),action,new NakedObject[]{source}).canUse().isAllowed()) {
      Naked result=target.execute(action,new NakedObject[]{source});
      if (result != null) {
        View view=ViewFactory.getViewFactory().createOpenRootView(result);
        Location location=new Location();
        location.move(10,10);
        view.setLocation(location);
        getWorkspace().addView(view);
      }
      markDamaged();
    }
 else {
      NakedObjectField[] fields=target.getSpecification().getVisibleFields(target,ClientSession.getSession());
      for (int i=0; i < fields.length; i++) {
        if (source.getSpecification().isOfType(fields[i].getSpecification()) && target.getField(fields[i]) == null) {
          target.setAssociation(((NakedObjectAssociation)fields[i]),source);
          invalidateContent();
          break;
        }
      }
    }
  }
}
