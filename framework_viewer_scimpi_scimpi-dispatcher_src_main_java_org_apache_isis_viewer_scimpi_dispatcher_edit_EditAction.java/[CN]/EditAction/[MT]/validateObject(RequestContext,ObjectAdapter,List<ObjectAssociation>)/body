{
  final FormState formState=new FormState();
  for (int i=0; i < fields.size(); i++) {
    final ObjectAssociation field=fields.get(i);
    final String fieldId=field.getId();
    String newEntry=context.getParameter(fieldId);
    if (fields.get(i).isOneToManyAssociation()) {
      continue;
    }
    if (fields.get(i).isVisible(IsisContext.getAuthenticationSession(),object).isVetoed()) {
      continue;
    }
    if (field.isUsable(IsisContext.getAuthenticationSession(),object).isVetoed()) {
      continue;
    }
    if (newEntry != null && newEntry.equals("-OTHER-")) {
      newEntry=context.getParameter(fieldId + "-other");
    }
    if (newEntry == null) {
      final ObjectSpecification spec=field.getSpecification();
      if (spec.isOfType(IsisContext.getSpecificationLoader().loadSpecification(boolean.class)) || spec.isOfType(IsisContext.getSpecificationLoader().loadSpecification(Boolean.class))) {
        newEntry=FALSE;
      }
 else {
        continue;
      }
    }
    final FieldEditState fieldState=formState.createField(fieldId,newEntry);
    Consent consent=null;
    if (field.isMandatory() && (newEntry.equals("") || newEntry.equals("NULL"))) {
      consent=new Veto(field.getName() + " required");
      formState.setError("Not all fields have been set");
    }
 else     if (field.getSpecification().containsFacet(ParseableFacet.class)) {
      try {
        final ParseableFacet facet=field.getSpecification().getFacet(ParseableFacet.class);
        final ObjectAdapter originalValue=field.get(object);
        Localization localization=IsisContext.getLocalization();
        final ObjectAdapter newValue=facet.parseTextEntry(originalValue,newEntry,localization);
        consent=((OneToOneAssociation)field).isAssociationValid(object,newValue);
        fieldState.setValue(newValue);
      }
 catch (      final TextEntryParseException e) {
        consent=new Veto(e.getMessage());
      }
    }
 else {
      final ObjectAdapter associate=newEntry.equals("null") ? null : context.getMappedObject(newEntry);
      if (associate != null) {
        IsisContext.getPersistenceSession().resolveImmediately(associate);
      }
      consent=((OneToOneAssociation)field).isAssociationValid(object,associate);
      fieldState.setValue(associate);
    }
    if (consent.isVetoed()) {
      fieldState.setError(consent.getReason());
      formState.setError("Not all fields have been entered correctly");
    }
  }
  return formState;
}
