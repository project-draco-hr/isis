{
  final HttpServletRequest httpRequest=(HttpServletRequest)request;
  final HttpSession httpSession=httpRequest.getSession(true);
  final AuthenticationManager authenticationManager=(AuthenticationManager)httpSession.getServletContext().getAttribute(AUTHENTICATION_MANAGER_WEBAPP_CONTEXT_KEY);
  if (authenticationManager == null) {
    throw new IllegalStateException("No authentication manager configured.");
  }
  AuthenticationSession isisAuthSession=null;
  final DeploymentType deploymentType=IsisContext.getDeploymentType();
  if (deploymentType.isExploring()) {
    isisAuthSession=new ExplorationSession();
  }
 else {
    isisAuthSession=(AuthenticationSession)httpSession.getAttribute(ISIS_SESSION_REQUEST_KEY);
    if (isisAuthSession != null) {
      if (!authenticationManager.isSessionValid(isisAuthSession)) {
        isisAuthSession=null;
      }
    }
    if (isisAuthSession == null) {
      final String user=httpRequest.getParameter("user");
      final String password=httpRequest.getParameter("password");
      final AuthenticationRequest passwordRequest=new AuthenticationRequestPassword(user,password);
      isisAuthSession=authenticationManager.authenticate(passwordRequest);
    }
  }
  httpSession.setAttribute(ISIS_SESSION_REQUEST_KEY,isisAuthSession);
  return isisAuthSession;
}
