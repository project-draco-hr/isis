{
  final List<String> propertyIds=Lists.newArrayList();
  final List<String> collectionIds=Lists.newArrayList();
  final List<String> actionIds=Lists.newArrayList();
  final AtomicReference<PropertyGroup> defaultPropertyGroupRef=new AtomicReference<>();
  final AtomicReference<Column> firstColumnRef=new AtomicReference<>();
  final AtomicReference<TabGroup> lastTabGroupRef=new AtomicReference<>();
  metadata.visit(new DomainObject.VisitorAdapter(){
    @Override public void visit(    final Property property){
      propertyIds.add(property.getId());
    }
    @Override public void visit(    final Collection collection){
      collectionIds.add(collection.getId());
    }
    @Override public void visit(    final Action action){
      actionIds.add(action.getId());
    }
  }
);
  metadata.visit(new DomainObject.VisitorAdapter(){
    @Override public void visit(    final Column column){
      firstColumnRef.compareAndSet(null,column);
    }
    @Override public void visit(    final PropertyGroup propertyGroup){
      if (MemberGroupLayoutFacet.DEFAULT_GROUP.equals(propertyGroup.getName())) {
        defaultPropertyGroupRef.compareAndSet(null,propertyGroup);
      }
    }
    @Override public void visit(    final TabGroup tabGroup){
      lastTabGroupRef.set(tabGroup);
    }
  }
);
  final List<String> missingPropertyIds=Lists.newArrayList(oneToOneAssociationById.keySet());
  missingPropertyIds.removeAll(propertyIds);
  if (!missingPropertyIds.isEmpty()) {
    boolean wasSet=defaultPropertyGroupRef.compareAndSet(null,new PropertyGroup(MemberGroupLayoutFacet.DEFAULT_GROUP));
    final PropertyGroup defaultPropertyGroup=defaultPropertyGroupRef.get();
    if (wasSet) {
      firstColumnRef.get().getPropertyGroups().add(defaultPropertyGroup);
    }
    Iterables.removeAll(propertyIds,oneToOneAssociationById.keySet());
    for (    final String propertyId : missingPropertyIds) {
      defaultPropertyGroup.getProperties().add(new Property(propertyId));
    }
  }
  final List<String> missingCollectionIds=Lists.newArrayList(oneToManyAssociationById.keySet());
  missingCollectionIds.removeAll(collectionIds);
  if (!missingCollectionIds.isEmpty()) {
    while (metadata.getTabGroups().size() < 2) {
      final TabGroup tabGroup=new TabGroup();
      metadata.getTabGroups().add(tabGroup);
      lastTabGroupRef.set(tabGroup);
    }
    final TabGroup lastTabGroup=lastTabGroupRef.get();
    for (    final String collectionId : missingCollectionIds) {
      final Tab tab=new Tab();
      lastTabGroup.getTabs().add(tab);
      Column left=new Column(12);
      tab.setLeft(left);
      left.getCollections().add(new Collection(collectionId));
    }
  }
  final List<String> missingActionIds=Lists.newArrayList(objectActionById.keySet());
  missingActionIds.removeAll(actionIds);
  if (!missingActionIds.isEmpty()) {
    for (    String actionId : missingActionIds) {
      metadata.getActions().add(new Action(actionId));
    }
  }
}
