{
  final PersistenceSessionProxy persistenceSession=new PersistenceSessionProxy(persistenceSessionFactory,adapterFactory,objectFactory,servicesInjector,oidGenerator,adapterManager,getServerFacade(),getEncoderDecoder());
  IsisTransactionManager transactionManager=createTransactionManager(getConfiguration(),persistenceSession.getAdapterManager(),persistenceSession);
  ensureThatArg(persistenceSession,is(not(nullValue())));
  ensureThatArg(transactionManager,is(not(nullValue())));
  transactionManager.injectInto(persistenceSession);
  return persistenceSession;
}
