{
  disallowSourceAndDefault(request);
  String sourceObjectId=objectOrResult(request);
  Class<?> cls=forClass(request);
  String variableName=request.getRequiredProperty(NAME);
  String defaultObjectId=request.getOptionalProperty(DEFAULT);
  String scopeName=request.getOptionalProperty(SCOPE);
  Scope scope=RequestContext.scope(scopeName,Scope.REQUEST);
  RequestContext context=request.getContext();
  ObjectAdapter sourceObject=context.getMappedObject(sourceObjectId);
  boolean isSourceSet=sourceObject != null;
  boolean isSourceAssignable=isSourceSet && (cls == null || cls.isAssignableFrom(sourceObject.getObject().getClass()));
  if (isSourceAssignable) {
    request.appendDebug("     " + variableName + " set to "+ sourceObjectId+ " ("+ scope+ ")");
    context.addVariable(variableName,sourceObjectId,scope);
  }
 else {
    request.appendDebug("     " + variableName + " set to "+ sourceObjectId+ " ("+ scope+ ")");
    if (defaultObjectId != null) {
      context.addVariable(variableName,defaultObjectId,scope);
    }
    context.changeScope(variableName,scope);
  }
}
