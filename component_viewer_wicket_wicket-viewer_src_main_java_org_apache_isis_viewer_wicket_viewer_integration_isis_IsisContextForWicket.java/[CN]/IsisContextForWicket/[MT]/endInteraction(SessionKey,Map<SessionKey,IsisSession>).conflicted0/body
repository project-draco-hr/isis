{
  final AuthenticatedWebSessionForIsis wicketSession=sessionKey.wicketSession;
synchronized (wicketSession) {
    final String wicketSessionId=wicketSession.getId();
    final int before=wicketSession.getThreadUsage();
    final boolean shouldClose=wicketSession.deregisterUseByThread();
    final int after=wicketSession.getThreadUsage();
    final IsisSession isisSession=sessionMap.get(sessionKey);
    AuthenticationSession authSession=null;
    String logMsg="";
    try {
      if (isisSession == null) {
        logMsg="NO_SESSION";
        return;
      }
      authSession=isisSession.getAuthenticationSession();
      if (!shouldClose) {
        logMsg="BUMP_DOWN ";
        return;
      }
      isisSession.close();
      logMsg="DISCARDING";
      sessionMap.remove(sessionKey);
    }
  finally {
      if (LOG.isDebugEnabled()) {
        LOG.debug(String.format("wicketSession: %s CLOSE %d -> %d %s %s %s",wicketSessionId,before,after,logMsg,(authSession != null ? authSession.getUserName() : "[null]"),(isisSession != null ? isisSession.getId() : "[null]")));
      }
    }
  }
}
