{
  Color textColor;
  int baseline=getBaseline();
  if (getState().isInvalid()) {
    textColor=Style.INVALID;
  }
 else   if (hasFocus()) {
    if (isSaved) {
      textColor=Style.PRIMARY1;
    }
 else {
      textColor=Style.TEXT_EDIT;
    }
  }
 else {
    textColor=Style.BLACK;
  }
  for (int i=displayFromLine; i <= displayToLine; i++) {
    String chars=textContent.getText(i);
    if (chars.endsWith("\n")) {
      throw new RuntimeException();
    }
    if (hasFocus() && (cursor.line == i) && canChangeValue()) {
      int at=Math.min(cursor.character,chars.length());
      int pos=style.stringWidth(chars.substring(0,at));
      canvas.drawLine(pos + (HPADDING),(baseline + style.getDescent()),pos + (HPADDING),baseline - style.getAscent(),Style.PRIMARY1);
    }
    canvas.drawText(chars,HPADDING,baseline,textColor,style);
    baseline+=lineHeight();
  }
}
