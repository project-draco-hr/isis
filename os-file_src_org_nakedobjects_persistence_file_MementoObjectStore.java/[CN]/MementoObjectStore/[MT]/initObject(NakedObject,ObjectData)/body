{
  FieldSpecification[] fields=object.getSpecification().getFields();
  for (int i=0; i < fields.length; i++) {
    FieldSpecification field=fields[i];
    if (field.isDerived()) {
      continue;
    }
    if (field.isValue()) {
      data.restoreValue(field.getName(),(NakedValue)field.get(object));
    }
 else     if (field instanceof OneToManyAssociationSpecification) {
      ReferenceVector refs=(ReferenceVector)data.get(field.getName());
      if (refs != null) {
        InternalCollection collection=(InternalCollection)field.get(object);
        SerialOid oid=refs.getOid();
        LOG.debug("setting collection " + field + "; assigning "+ oid+ " to "+ collection);
        if (oid == null) {
          throw new NakedObjectRuntimeException("Oid does not exist for " + collection);
        }
        if (collection.getOid() == null) {
          collection.setOid(oid);
        }
        for (int j=0; j < refs.size(); j++) {
          try {
            if (loadedObjects.isLoaded(refs.elementAt(j))) {
              collection.added(loadedObjects.getLoadedObject(refs.elementAt(j)));
            }
 else {
              collection.added(getObject(refs.elementAt(j),null));
            }
          }
 catch (          ObjectNotFoundException e) {
            e.printStackTrace();
          }
        }
      }
    }
 else {
      Oid reference=(Oid)data.get(field.getName());
      LOG.debug("setting field " + field + " with "+ reference);
      if (reference != null) {
        if (loadedObjects.isLoaded(reference)) {
          NakedObject loadedObject=loadedObjects.getLoadedObject(reference);
          LOG.debug("using loaded object " + loadedObject);
          ((OneToOneAssociationSpecification)field).initData(object,loadedObject);
        }
 else {
          Oid oid=reference;
          NakedObject fieldObject;
          Data fieldData=(Data)dataManager.loadData((SerialOid)oid);
          if (fieldData != null) {
            fieldObject=(NakedObject)classFor(fieldData.getClassName()).acquireInstance();
          }
 else {
            fieldObject=(NakedObject)field.getType().acquireInstance();
          }
          fieldObject.setOid(oid);
          if (fieldObject instanceof InternalCollection) {
            fieldObject.setResolved();
          }
          loadedObjects.loaded(fieldObject);
          ((OneToOneAssociationSpecification)field).initData(object,fieldObject);
        }
      }
    }
  }
}
