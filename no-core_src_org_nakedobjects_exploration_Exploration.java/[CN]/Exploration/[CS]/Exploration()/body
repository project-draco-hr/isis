{
  try {
    Properties p=Configuration.loadProperties("log4j.properties");
    PropertyConfigurator.configure(p);
  }
 catch (  ConfigurationException e) {
    BasicConfigurator.configure();
  }
  Logger.getRootLogger().setLevel(Level.WARN);
  NakedObjectManager objectManager=null;
  try {
    String name=this.getClass().getName();
    name=name.substring(name.lastIndexOf('.') + 1);
    loadConfiguration();
    showSplash();
    setUpLocale();
    ObjectViewingMechanism viewer=installViewer();
    objectManager=installObjectManager(viewer.getUpdateNotifier());
    NakedObjectSpecification.setReflectionFactory(new LocalReflectionFactory());
    NakedObjectContext context=new NakedObjectContext(objectManager);
    explorationSetUp=new ExplorationSetUp(context);
    setUpFixtures();
    setUpFixture();
    Session.getSession().setSecurityContext(context);
    ExplorationContext applicationContext;
    User user;
    NakedObjectSpecification userClass=NakedObjectSpecification.getNakedClass(User.class.getName());
    if (objectManager.hasInstances(userClass)) {
      InstanceCollection users=objectManager.findInstances(userClass,name);
      if (users.size() == 0) {
        throw new NakedObjectRuntimeException("No users found: " + name);
      }
      user=(User)users.elements().nextElement();
      applicationContext=(ExplorationContext)user.getRootObject();
    }
 else {
      user=new User(name);
      user.setContext(context);
      user.getRoles().add(new Role("explorer"));
      applicationContext=new ExplorationContext();
      applicationContext.setContext(context);
      applicationContext.getName().setValue(name);
      applicationContext.associateUser(user);
      objectManager.makePersistent(applicationContext);
    }
    explorationSetUp.installFixtures();
    String[] classes=explorationSetUp.getClasses();
    for (int i=0; i < classes.length; i++) {
      applicationContext.addClass(classes[i]);
    }
    InstanceCollection coll=objectManager.allInstances(userClass);
    applicationContext.setUpUsers(coll);
    context.setUser(user);
    NakedObject rootObject=user.getRootObject();
    if (rootObject == null) {
      LOG.warn("User had no root context, a default one has been assigned");
      rootObject=new DefaultUserContext();
      rootObject.created();
      objectManager.makePersistent(rootObject);
      user.setRootObject(rootObject);
      ((DefaultUserContext)rootObject).setUser(user);
    }
    viewer.setTitle(name);
    viewer.init(rootObject,this);
    viewer.start();
  }
 catch (  ConfigurationException e) {
    throw new NakedObjectRuntimeException(e);
  }
catch (  StartupException e) {
    if (objectManager == null) {
      objectManager.shutdown();
    }
    throw new NakedObjectRuntimeException(e);
  }
}
