{
  final Version pojoVersion=getVersionIfAny(pojo);
  final RootOid oid;
  ObjectAdapter adapter=getAdapterManager().getAdapterFor(pojo);
  if (adapter != null) {
    ensureRootObject(pojo);
    oid=(RootOid)adapter.getOid();
    final Version previousVersion=adapter.getVersion();
    getAdapterManager().removeAdapter(adapter);
    adapter.replacePojo(pojo);
    getAdapterManager().addExistingAdapter(adapter);
    if (previousVersion != null && pojoVersion != null) {
      if (previousVersion.different(pojoVersion)) {
        getCurrentTransaction().addException(new ConcurrencyException(adapter,pojoVersion));
      }
    }
  }
 else {
    final OidGenerator oidGenerator=getOidGenerator();
    oid=oidGenerator.createPersistent(pojo,null);
    adapter=getAdapterManager().getAdapterFor(oid);
    if (adapter != null) {
      getAdapterManager().removeAdapter(adapter);
      adapter.replacePojo(pojo);
      getAdapterManager().addExistingAdapter(adapter);
    }
 else {
      adapter=getAdapterManager().mapRecreatedPojo(oid,pojo);
    }
  }
  if (!adapter.isResolved()) {
    PersistorUtil.startResolving(adapter);
    PersistorUtil.endResolving(adapter);
  }
  adapter.setVersion(pojoVersion);
  ensureFrameworksInAgreement(pojo);
}
