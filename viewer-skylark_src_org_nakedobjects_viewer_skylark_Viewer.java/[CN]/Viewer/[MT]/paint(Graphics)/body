{
  redrawCount++;
  g.translate(insets.left,insets.top);
  int w=internalDisplaySize.getWidth();
  int h=internalDisplaySize.getHeight();
  if (doubleBuffering) {
    if ((doubleBuffer == null) || (bufferGraphics == null) || (doubleBuffer.getWidth(null) < w)|| (doubleBuffer.getHeight(null) < h)) {
      doubleBuffer=renderingArea.createImage(w,h);
      LOG.debug("buffer sized to " + doubleBuffer.getWidth(null) + "x"+ doubleBuffer.getHeight(null));
    }
    bufferGraphics=doubleBuffer.getGraphics().create();
  }
 else {
    bufferGraphics=g;
  }
  Rectangle r=g.getClipBounds();
  bufferGraphics.clearRect(r.x,r.y,r.width,r.height);
  bufferGraphics.clearRect(0,0,w,h);
  bufferGraphics.setClip(r.x,r.y,r.width,r.height);
  Canvas c=new DrawingCanvas(bufferGraphics,r.x,r.y,r.width,r.height);
  if (spy != null) {
    spy.redraw(r,redrawCount);
  }
  if (AbstractView.debug) {
    LOG.debug("------ repaint viewer #" + redrawCount + " "+ r.x+ ","+ r.y+ " "+ r.width+ "x"+ r.height);
  }
  if (rootView != null) {
    rootView.draw(c.createSubcanvas());
  }
  overlayView.draw(c.createSubcanvas(overlayView.getBounds()));
  paintUserStatus(bufferGraphics);
  if (doubleBuffering) {
    g.drawImage(doubleBuffer,0,0,null);
  }
  if (showRepaintArea) {
    g.setColor(Color.DEBUG_REPAINT_BOUNDS.getAwtColor());
    g.drawRect(r.x,r.y,r.width - 1,r.height - 1);
    g.drawString("#" + redrawCount,r.x + 3,r.y + 15);
  }
}
