{
  if (IsisContext.getCurrentTransaction() != null) {
    List<String> messages=IsisContext.getMessageBroker().getMessages();
    for (    String message : messages) {
      requestContext.getWriter().append("<div class=\"message\">message: " + message + "</div>");
      error.appendln("message",message);
    }
    messages=IsisContext.getMessageBroker().getWarnings();
    for (    String message : messages) {
      requestContext.getWriter().append("<div class=\"message\">warning: " + message + "</div>");
      error.appendln("warning",message);
    }
  }
  ByteArrayOutputStream out=new ByteArrayOutputStream();
  writeErrorContent(requestContext,exception,error,new PrintWriter(out),false);
  PrintWriter writer;
  try {
    requestContext.addVariable("_error-ref",errorRef,Scope.INTERACTION);
    String directory=IsisContext.getConfiguration().getString(ConfigurationConstants.ROOT + "scimpi.error-snapshots",".");
    writer=new PrintWriter(new File(directory,"error_" + errorRef + ".html"));
    writeErrorContent(requestContext,exception,new DebugString(),writer,true);
  }
 catch (  FileNotFoundException e) {
    LOG.error("Failed to archive error page",e);
  }
  String replace="";
  String withReplacement="";
  String message=exception.getMessage();
  requestContext.addVariable("_error-message",message == null ? "" : message.replaceAll(replace,withReplacement),Scope.INTERACTION);
  requestContext.addVariable("_error-details",out.toString().replaceAll(replace,withReplacement),Scope.INTERACTION);
  requestContext.clearTransientVariables();
}
