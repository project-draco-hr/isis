{
  try {
    AuthenticationSession session=UserManager.startRequest(context);
    LOG.debug("exsiting session: " + session);
    LOG.info("processing request " + servletPath);
    IsisContext.getPersistenceSession().getTransactionManager().startTransaction();
    context.setRequestPath(servletPath);
    context.startRequest();
    processActions(context,servletPath);
    IsisTransactionManager transactionManager=IsisContext.getPersistenceSession().getTransactionManager();
    if (transactionManager.getTransaction().getState().canFlush()) {
      transactionManager.flushTransaction();
    }
    processView(context);
    transactionManager=IsisContext.getPersistenceSession().getTransactionManager();
    if (transactionManager.getTransaction().getState().canCommit()) {
      IsisContext.getPersistenceSession().getTransactionManager().endTransaction();
    }
  }
 catch (  Throwable e) {
    LOG.error(e.getMessage(),e);
    DebugString error=new DebugString();
    List<String> messages=IsisContext.getMessageBroker().getMessages();
    for (    String message : messages) {
      context.getWriter().append("<div class=\"message\">message: " + message + "</div>");
      error.appendln("message",message);
    }
    messages=IsisContext.getMessageBroker().getWarnings();
    for (    String message : messages) {
      context.getWriter().append("<div class=\"message\">warning: " + message + "</div>");
      error.appendln("warning",message);
    }
    generateErrorPage(e,context,error);
    PersistenceSession checkSession=IsisContext.getPersistenceSession();
    IsisTransactionManager transactionManager=checkSession.getTransactionManager();
    if (transactionManager.getTransaction().getState().canAbort()) {
      transactionManager.abortTransaction();
    }
    String message="failed while processing " + servletPath;
    LOG.error(message + "\n" + error+ "\n"+ message,e);
  }
 finally {
    try {
      context.endRequest();
    }
 catch (    Exception e) {
      LOG.error("endRequest call failed",e);
    }
    try {
      UserManager.endRequest(context.getSession());
    }
 catch (    Exception e) {
      LOG.error("endRequest call failed",e);
    }
  }
}
