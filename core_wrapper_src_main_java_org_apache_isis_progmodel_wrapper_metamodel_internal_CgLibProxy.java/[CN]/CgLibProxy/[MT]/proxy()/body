{
  final T toProxy=handler.getDelegate();
  if (CglibEnhanced.class.isAssignableFrom(toProxy.getClass())) {
    handler.setResolveObjectChangedEnabled(true);
    final Class<? extends Object> enhancedClass=toProxy.getClass();
    final Class<? extends Object> origSuperclass=toProxy.getClass().getSuperclass();
    final List<Class> interfaces=new ArrayList<Class>();
    interfaces.addAll(Arrays.asList(enhancedClass.getInterfaces()));
    interfaces.remove(Factory.class);
    interfaces.add(WrapperObject.class);
    InvocationHandlerMethodInterceptor interceptor=new InvocationHandlerMethodInterceptor(handler);
    return (T)Enhancer.create(origSuperclass,interfaces.toArray(new Class[]{}),interceptor);
  }
  final Class<T> clazz=(Class<T>)toProxy.getClass();
  T proxy=null;
  try {
    final IProxyFactory<T> proxyFactory=clazz.isInterface() ? new JavaProxyFactory<T>() : new CgLibClassProxyFactory<T>();
    proxy=proxyFactory.createProxy(clazz,handler);
  }
 catch (  final RuntimeExceptionWrapper e) {
    throw (RuntimeException)e.getRuntimeException().fillInStackTrace();
  }
  return proxy;
}
