{
  ensureThatState(getState().canCommit(),is(true),"state is: " + getState());
  ensureThatState(abortCause,is(nullValue()),"cannot commit: an abort cause has been set");
  if (LOG.isDebugEnabled()) {
    LOG.debug("preCommit transaction " + this);
  }
  if (getState() == State.COMMITTED) {
    if (LOG.isInfoEnabled()) {
      LOG.info("already committed; ignoring");
    }
    return;
  }
  try {
    final Command command=commandContext.getCommand();
    final boolean hasChangedAdapters=changedObjectsServiceInternal.hasChangedAdapters();
    if (hasChangedAdapters && command.getMemberIdentifier() != null) {
      command.setPersistHint(true);
    }
    auditingServiceInternal.audit();
    publishingServiceInternal.publishObjects();
    doFlush();
    final ActionInvocationContext actionInvocationContext=lookupService(ActionInvocationContext.class);
    if (actionInvocationContext != null) {
      Bulk.InteractionContext.current.set(null);
    }
    completeCommandAndInteractionAndClearDomainEvents();
    doFlush();
  }
 catch (  final RuntimeException ex) {
    setAbortCause(new IsisTransactionManagerException(ex));
    completeCommandAndInteractionAndClearDomainEvents();
    throw ex;
  }
}
