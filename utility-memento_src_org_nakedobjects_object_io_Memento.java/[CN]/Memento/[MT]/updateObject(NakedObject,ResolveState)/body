{
  Object oid=object.getOid();
  if (oid != null && !oid.equals(state.oid)) {
    throw new IllegalArgumentException("This memento can only be used to " + "update the naked object with the Oid " + state.oid);
  }
 else {
    if (!(state instanceof ObjectData)) {
      throw new NakedObjectRuntimeException("Expected an ObjectData but got " + state.getClass());
    }
 else {
      NakedObjectLoader objectLoader=NakedObjects.getObjectLoader();
      objectLoader.start(object,resolveState);
      ObjectData od=(ObjectData)state;
      NakedObjectField[] fields=object.getSpecification().getFields();
      for (int i=0; i < fields.length; i++) {
        NakedObjectField field=fields[i];
        Object fieldData=od.getEntry(field.getId());
        if (!field.isDerived()) {
          if (field.isCollection()) {
            updateOneToManyAssociation(object,(OneToManyAssociation)field,(CollectionData)fieldData);
          }
 else           if (field.isObject()) {
            updateOneToOneAssociation(object,(OneToOneAssociation)field,(Data)fieldData);
          }
 else           if (field.isValue()) {
            object.initValue((OneToOneAssociation)field,fieldData);
          }
        }
      }
      objectLoader.end(object);
    }
    LOG.debug("object updated " + object.getOid());
  }
}
