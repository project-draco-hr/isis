{
  final CommandContext commandContext=getServicesInjector().lookupService(CommandContext.class);
  final Command command=commandContext != null ? commandContext.getCommand() : null;
  final ActionDomainEvent<?> event=domainEventHelper.postEventForAction(AbstractDomainEvent.Phase.EXECUTING,eventType,null,owningAction,targetAdapter,arguments,command,null);
  final InvocationResult invocationResult=internalInvoke(command,owningAction,targetAdapter,arguments);
  final ObjectAdapter invocationResultAdapter=invocationResult.getAdapter();
  if (invocationResult.getWhetherInvoked()) {
    domainEventHelper.postEventForAction(AbstractDomainEvent.Phase.EXECUTED,eventType,verify(event),owningAction,targetAdapter,arguments,command,invocationResultAdapter);
  }
  if (invocationResultAdapter == null) {
    return null;
  }
  boolean filterForVisibility=InteractionUtils.FILTERING.get() && getConfiguration().getBoolean("isis.reflector.facet.filterVisibility",true);
  if (filterForVisibility) {
    final Object result=invocationResultAdapter.getObject();
    if (result instanceof Collection || result.getClass().isArray()) {
      final CollectionFacet facet=CollectionFacet.Utils.getCollectionFacetFromSpec(invocationResultAdapter);
      final Iterable<ObjectAdapter> adapterList=facet.iterable(invocationResultAdapter);
      final List<ObjectAdapter> visibleAdapters=ObjectAdapter.Util.visibleAdapters(adapterList,session,deploymentCategory,interactionInitiatedBy);
      final Object visibleObjects=CollectionUtils.copyOf(Lists.transform(visibleAdapters,ObjectAdapter.Functions.getObject()),method.getReturnType());
      if (visibleObjects != null) {
        return getAdapterManager().adapterFor(visibleObjects);
      }
    }
 else {
      boolean visible=ObjectAdapter.Util.isVisible(invocationResultAdapter,session,deploymentCategory,interactionInitiatedBy);
      if (!visible) {
        return null;
      }
    }
  }
  return invocationResultAdapter;
}
