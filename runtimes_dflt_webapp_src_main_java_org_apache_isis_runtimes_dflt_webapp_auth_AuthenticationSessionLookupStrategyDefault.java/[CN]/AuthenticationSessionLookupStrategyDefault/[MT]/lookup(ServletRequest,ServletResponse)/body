{
  final HttpSession httpSession=getHttpSession(servletRequest);
  AuthenticationSession authSession=(AuthenticationSession)httpSession.getAttribute(WebAppConstants.HTTP_SESSION_AUTHENTICATION_SESSION_KEY);
  if (authSession != null) {
    final boolean sessionValid=getAuthenticationManager().isSessionValid(authSession);
    if (sessionValid) {
      return authSession;
    }
  }
  final ServletContext servletContext=getServletContext(servletRequest);
  final IsisSystem system=(IsisSystem)servletContext.getAttribute(WebAppConstants.ISIS_SYSTEM_KEY);
  if (system == null) {
    return null;
  }
  final LogonFixture logonFixture=system.getLogonFixture();
  if (system.getDeploymentType().isExploring()) {
    authSession=getAuthenticationManager().authenticate(new AuthenticationRequestExploration(logonFixture));
    if (authSession != null) {
      return authSession;
    }
  }
  final boolean loggedInUsingLogonFixture=httpSession.getAttribute(WebAppConstants.HTTP_SESSION_LOGGED_ON_PREVIOUSLY_USING_LOGON_FIXTURE_KEY) != null;
  if (logonFixture != null && !loggedInUsingLogonFixture) {
    httpSession.setAttribute(WebAppConstants.HTTP_SESSION_LOGGED_ON_PREVIOUSLY_USING_LOGON_FIXTURE_KEY,true);
    return getAuthenticationManager().authenticate(new AuthenticationRequestLogonFixture(logonFixture));
  }
  return null;
}
