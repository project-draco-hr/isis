{
  if (LOG.isDebugEnabled()) {
    LOG.debug("installing " + this.getClass().getName());
  }
  ObjectAdapterFactory adapterFactory=persistenceSessionFactory.getAdapterFactory();
  PojoRecreator pojoRecreator=new PojoRecreatorUnified(getConfiguration());
  ServicesInjectorSpi servicesInjector=persistenceSessionFactory.getServicesInjector();
  final AdapterManagerDefault adapterManager=new AdapterManagerDefault(pojoRecreator);
  ObjectStoreSpi objectStore=createObjectStore(getConfiguration(),adapterFactory,adapterManager);
  ensureThatArg(objectStore,is(not(nullValue())));
  if (getConfiguration().getBoolean(LOGGING_PROPERTY,false)) {
    final String level=getConfiguration().getString(LOGGING_PROPERTY + ".level","debug");
    objectStore=new IsisObjectStoreLogger(objectStore,level);
  }
  final PersistenceSession persistenceSession=new PersistenceSession(persistenceSessionFactory,adapterFactory,servicesInjector,adapterManager,objectStore,getConfiguration());
  final IsisTransactionManager transactionManager=new IsisTransactionManager(persistenceSession,objectStore,servicesInjector);
  persistenceSession.setDirtiableSupport(true);
  persistenceSession.setTransactionManager(transactionManager);
  return persistenceSession;
}
