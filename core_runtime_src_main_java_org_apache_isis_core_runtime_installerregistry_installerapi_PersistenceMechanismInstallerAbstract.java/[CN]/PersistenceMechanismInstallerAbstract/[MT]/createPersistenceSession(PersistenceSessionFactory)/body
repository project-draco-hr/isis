{
  if (LOG.isDebugEnabled()) {
    LOG.debug("installing " + this.getClass().getName());
  }
  ObjectAdapterFactory adapterFactory=persistenceSessionFactory.getAdapterFactory();
  ObjectFactory objectFactory=persistenceSessionFactory.getObjectFactory();
  PojoRecreator pojoRecreator=persistenceSessionFactory.getPojoRecreator();
  IdentifierGenerator identifierGenerator=persistenceSessionFactory.getIdentifierGenerator();
  ServicesInjectorSpi servicesInjector=persistenceSessionFactory.getServicesInjector();
  final PersistAlgorithm persistAlgorithm=createPersistAlgorithm(getConfiguration());
  final AdapterManagerDefault adapterManager=new AdapterManagerDefault(pojoRecreator);
  ObjectStoreSpi objectStore=createObjectStore(getConfiguration(),adapterFactory,adapterManager);
  ensureThatArg(persistAlgorithm,is(not(nullValue())));
  ensureThatArg(objectStore,is(not(nullValue())));
  if (getConfiguration().getBoolean(LOGGING_PROPERTY,false)) {
    final String level=getConfiguration().getString(LOGGING_PROPERTY + ".level","debug");
    objectStore=new IsisObjectStoreLogger(objectStore,level);
  }
  final PersistenceSession persistenceSession=new PersistenceSession(persistenceSessionFactory,adapterFactory,objectFactory,servicesInjector,identifierGenerator,adapterManager,persistAlgorithm,objectStore);
  final IsisTransactionManager transactionManager=createTransactionManager(persistenceSessionFactory,persistenceSession,objectStore);
  ensureThatArg(persistenceSession,is(not(nullValue())));
  ensureThatArg(transactionManager,is(not(nullValue())));
  persistenceSession.setDirtiableSupport(true);
  persistenceSession.setTransactionManager(transactionManager);
  return persistenceSession;
}
