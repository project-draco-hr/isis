{
  if (LOG.isDebugEnabled()) {
    LOG.debug("endTransaction: level " + (transactionLevel) + "->"+ (transactionLevel - 1));
  }
  final IsisTransaction transaction=getTransaction();
  if (transaction == null || transaction.getState().isComplete()) {
    return;
  }
  RuntimeException abortCause=this.getTransaction().getAbortCause();
  if (transaction.getState().mustAbort()) {
    if (LOG.isDebugEnabled()) {
      LOG.debug("endTransaction: aborting instead [EARLY TERMINATION], abort cause '" + abortCause.getMessage() + "' has been set");
    }
    abortTransaction();
    abortCause=this.getTransaction().getAbortCause();
    if (abortCause != null) {
      throw abortCause;
    }
 else {
      return;
    }
  }
  transactionLevel--;
  if (transactionLevel == 0) {
    if (abortCause == null) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("endTransaction: committing");
      }
      try {
        persistenceSession.objectChangedAllDirty();
      }
 catch (      RuntimeException ex) {
        abortCause=ex;
      }
    }
    if (abortCause == null) {
      try {
        getTransaction().commit();
      }
 catch (      RuntimeException ex) {
        abortCause=ex;
      }
    }
    if (abortCause == null) {
      try {
        transactionalResource.endTransaction();
      }
 catch (      RuntimeException ex) {
        abortCause=ex;
      }
    }
    if (abortCause != null) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("endTransaction: aborting instead, abort cause has been set");
      }
      try {
        abortTransaction();
      }
 catch (      RuntimeException ex) {
        abortCause=ex;
      }
      throw abortCause;
    }
  }
 else   if (transactionLevel < 0) {
    LOG.error("endTransaction: transactionLevel=" + transactionLevel);
    transactionLevel=0;
    throw new IllegalStateException(" no transaction running to end (transactionLevel < 0)");
  }
}
