{
  boolean noneInProgress=false;
  if (getTransaction() == null || getTransaction().getState().isComplete()) {
    noneInProgress=true;
    final Interaction interaction=interactionContext.getInteraction();
    final Command command;
    if (existingCommandIfAny != null) {
      commandContext.setCommand(existingCommandIfAny);
      interaction.setTransactionId(existingCommandIfAny.getTransactionId());
    }
    command=commandContext.getCommand();
    final UUID transactionId=command.getTransactionId();
    final MessageBroker messageBroker=getAuthenticationSession().getMessageBroker();
    this.transaction=new IsisTransaction(this,messageBroker,servicesInjector,transactionId,interaction.next(Interaction.Sequence.TRANSACTION.id()));
    transactionLevel=0;
    persistenceSession.startTransaction();
  }
  transactionLevel++;
  if (LOG.isDebugEnabled()) {
    LOG.debug("startTransaction: level " + (transactionLevel - 1) + "->"+ (transactionLevel)+ (noneInProgress ? " (no transaction in progress or was previously completed; transaction created)" : ""));
  }
}
