{
  if (LOG.isDebugEnabled()) {
    LOG.debug("createPersistenceQueryFor: " + query.getDescription());
  }
  final ObjectSpecification noSpec=specFor(query);
  if (query instanceof QueryFindAllInstances) {
    return new PersistenceQueryFindAllInstances(noSpec);
  }
  if (query instanceof QueryFindAllPaged) {
    QueryFindAllPaged<?> pagedQuery=(QueryFindAllPaged<?>)query;
    return new PersistenceQueryFindPaged(noSpec,pagedQuery.getStart(),pagedQuery.getCount());
  }
  if (query instanceof QueryFindByTitle) {
    final QueryFindByTitle<?> queryByTitle=(QueryFindByTitle<?>)query;
    final String title=queryByTitle.getTitle();
    return new PersistenceQueryFindByTitle(noSpec,title);
  }
  if (query instanceof QueryFindByPattern) {
    final QueryFindByPattern<?> queryByPattern=(QueryFindByPattern<?>)query;
    final Object pattern=queryByPattern.getPattern();
    final ObjectAdapter patternAdapter=getAdapterManager().adapterFor(pattern);
    return new PersistenceQueryFindByPattern(noSpec,patternAdapter);
  }
  if (query instanceof QueryDefault) {
    final QueryDefault<?> queryDefault=(QueryDefault<?>)query;
    final String queryName=queryDefault.getQueryName();
    final Map<String,ObjectAdapter> argumentsAdaptersByParameterName=wrap(queryDefault.getArgumentsByParameterName());
    return new PersistenceQueryFindUsingApplibQueryDefault(noSpec,queryName,argumentsAdaptersByParameterName,cardinality);
  }
  return new PersistenceQueryFindUsingApplibQuerySerializable(noSpec,query,cardinality);
}
