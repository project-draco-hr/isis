{
  Oid oid=object.getOid();
  NakedObjectSpecification specification=object.getSpecification();
  String type=specification.getFullName();
  if (savedObjects.contains(object) || (depth <= 0 && object.isPersistent())) {
    return createObjectData(oid,type,null);
  }
  savedObjects.addElement(object);
  NakedObjectField[] fields=specification.getFields();
  Object[] fieldContent=new Object[fields.length];
  for (int i=0; i < fields.length; i++) {
    if (fields[i].isEmpty(object)) {
      continue;
    }
    if (fields[i].isValue()) {
      fieldContent[i]=object.getField(fields[i]).getObject();
    }
 else     if (fields[i].isCollection()) {
      fieldContent[i]=createCollectionData(object.getField(fields[i]),savedObjects,depth - 1);
    }
 else {
      fieldContent[i]=createObjectData(object.getField(fields[i]),savedObjects,depth - 1);
    }
  }
  return createObjectData(oid,type,fieldContent);
}
