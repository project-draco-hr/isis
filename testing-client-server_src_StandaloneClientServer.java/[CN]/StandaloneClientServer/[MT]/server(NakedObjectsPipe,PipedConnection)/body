{
  final NakedObjectStore objectStore=new ObjectStoreLogger(objectStore(),"server-store.log");
  Runnable runnable=new Runnable(){
    public void run(){
      final PipedServer server=new PipedServer();
      server.setConnection(connection);
      nakedObjects.setConfiguration(new PropertiesConfiguration());
      JavaBusinessObjectContainer container=new JavaBusinessObjectContainer();
      new SystemClock();
      JavaObjectFactory objectFactory=new JavaObjectFactory();
      objectFactory.setContainer(container);
      OidGenerator oidGenerator=new SimpleOidGenerator();
      DefaultPersistAlgorithm persistAlgorithm=new DefaultPersistAlgorithm();
      persistAlgorithm.setOidGenerator(oidGenerator);
      ObjectStorePersistor objectStorePersistor=new ObjectStorePersistor();
      objectStorePersistor.setObjectStore(objectStore);
      objectStorePersistor.setPersistAlgorithm(persistAlgorithm);
      objectStorePersistor.setCheckObjectsForDirtyFlag(true);
      NakedObjectPersistor persistor=objectStorePersistor;
      nakedObjects.setObjectPersistor(persistor);
      ObjectLoaderImpl objectLoader=new ObjectLoaderImpl();
      objectLoader.setPojoAdapterMap(new PojoAdapterHashMap());
      objectLoader.setObjectFactory(objectFactory);
      objectLoader.setAdapterFactory(new JavaAdapterFactory());
      objectLoader.setIdentityAdapterMap(new IdentityAdapterHashMap());
      nakedObjects.setObjectLoader(objectLoader);
      ReflectionPeerFactory[] factories=new ReflectionPeerFactory[]{new TransactionPeerFactory()};
      JavaSpecificationLoader specificationLoader=new JavaSpecificationLoader();
      specificationLoader.setReflectionPeerFactories(factories);
      nakedObjects.setSpecificationLoader(specificationLoader);
      SingleResponseUpdateNotifier updateNotifier=new SingleResponseUpdateNotifier();
      ServerDistribution sd=new ServerDistribution();
      ObjectEncoder dataFactory=new ObjectEncoder();
      dataFactory.setDataFactory(new JavaDataFactory());
      sd.setEncoder(dataFactory);
      sd.setUpdateNotifier(updateNotifier);
      Distribution serverLogger=sd;
      server.setFacade(serverLogger);
      server.setDistribution(sd);
      persistor.addObjectChangedListener(updateNotifier);
      nakedObjects.init();
      JavaFixtureBuilder fb=new JavaFixtureBuilder();
      CitiesFixture cities;
      fb.addFixture(cities=new CitiesFixture());
      fb.addFixture(new BookingsFixture(cities));
      fb.addFixture(new ClassesFixture());
      fb.installFixtures();
      InfoDebugFrame debugFrame=new InfoDebugFrame(){
        private static final long serialVersionUID=1L;
        public void dialogClosing(){
          System.exit(0);
        }
      }
;
      debugFrame.setInfo(new DebugInfo[]{NakedObjects.debug(),NakedObjects.getObjectPersistor(),NakedObjects.getObjectLoader(),NakedObjects.getConfiguration(),NakedObjects.getSpecificationLoader(),updateNotifier});
      debugFrame.setBounds(500,300,1000,700);
      debugFrame.refresh();
      debugFrame.show();
      updateNotifier.clearUpdates();
      server.run();
    }
  }
;
  Thread serverThread=new Thread(runnable,"server");
  nakedObjects.setServer(serverThread);
  serverThread.start();
}
