{
  StringBuffer details=new StringBuffer();
  String header=layout.getHeader();
  if (header != null) {
    details.append(header);
  }
  int len=buffer.length();
  String message="";
  for (int i=0; i < len; i++) {
    LoggingEvent event=buffer.get();
    message=event.getLoggerName() + ": " + event.getMessage();
    details.append(layout.format(event));
    if (layout.ignoresThrowable()) {
      String[] s=event.getThrowableStrRep();
      if (s != null) {
        for (int j=0; j < s.length; j++) {
          details.append(s[j]);
          details.append('\n');
        }
      }
    }
  }
  if (addInfo) {
    String user=System.getProperty("user.name");
    String system=System.getProperty("os.name") + " (" + System.getProperty("os.arch")+ ") "+ System.getProperty("os.version");
    String java=System.getProperty("java.vm.name") + " " + System.getProperty("java.vm.version");
    String version=AboutNakedObjects.getFrameworkVersion() + " " + AboutNakedObjects.getFrameworkBuild();
    LoggingEvent infoEvent=new LoggingEvent("",Logger.getRootLogger(),Level.INFO,"Snapshot:- " + new Date() + "\n\t"+ user+ "\n\t"+ system+ "\n\t"+ java+ "\n\t"+ version,null);
    details.append(layout.format(infoEvent));
  }
  String footer=layout.getFooter();
  if (footer != null) {
    details.append(footer);
  }
  writeSnapshot(message,details.toString());
}
