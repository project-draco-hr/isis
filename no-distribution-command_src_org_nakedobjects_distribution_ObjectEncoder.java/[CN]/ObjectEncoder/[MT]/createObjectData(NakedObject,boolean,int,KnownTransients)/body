{
  if (object == null) {
    return null;
  }
  if (knownTransients.containsKey(object)) {
    return (ObjectData)knownTransients.get(object);
  }
  ResolveState resolveState=object.getResolveState();
  boolean addCompleteData=object.getResolveState() == ResolveState.TRANSIENT || object.getResolveState() == ResolveState.RESOLVED;
  Oid oid=object.getOid();
  NakedObjectSpecification specification=object.getSpecification();
  String type=specification.getFullName();
  ObjectData data=factory.createObjectData(oid,type,addCompleteData,object.getVersion());
  boolean isTransient=object.getResolveState().isTransient();
  if (isTransient) {
    knownTransients.put(object,data);
  }
  if (resolveState.isSerializing()) {
    return data;
  }
  boolean nextLevel=isTransient || recursePersistentObjects;
  Data[] fieldContent;
  if (resolveState.isSerializing() || !nextLevel || depth == 0 || resolveState.isGhost()) {
    fieldContent=null;
  }
 else {
    NakedObjectField[] fields=getFields(specification);
    fieldContent=new Data[fields.length];
    NakedObjects.getObjectLoader().start(object,object.getResolveState().serializeFrom());
    for (int i=0; i < fields.length; i++) {
      Naked field=object.getField(fields[i]);
      if (fields[i].isDerived()) {
        fieldContent[i]=null;
      }
 else       if (field == null && addCompleteData) {
        fieldContent[i]=factory.createNullData(fields[i].getSpecification().getFullName());
      }
 else       if (field == null && !addCompleteData) {
        fieldContent[i]=null;
      }
 else       if (fields[i].isValue()) {
        fieldContent[i]=createValueData(field);
      }
 else       if (fields[i].isCollection()) {
        fieldContent[i]=createCollection((NakedCollection)field,recursePersistentObjects,depth - 1,knownTransients);
      }
 else {
        if ((recursePersistentObjects && depth > 0) || isTransient) {
          fieldContent[i]=createObjectData((NakedObject)field,recursePersistentObjects,depth - 1,knownTransients);
        }
 else {
          fieldContent[i]=createReference((NakedObject)field);
        }
      }
    }
    NakedObjects.getObjectLoader().end(object);
  }
  data.setFieldContent(fieldContent);
  return data;
}
