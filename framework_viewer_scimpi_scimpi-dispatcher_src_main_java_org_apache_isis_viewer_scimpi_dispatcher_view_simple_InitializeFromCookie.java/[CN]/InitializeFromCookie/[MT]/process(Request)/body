{
  final String name=request.getRequiredProperty(NAME);
  final RequestContext context=request.getContext();
  if (context.getVariable(name) != null) {
    request.skipUntilClose();
  }
 else {
    final String scopeName=request.getOptionalProperty(SCOPE);
    final Scope scope=RequestContext.scope(scopeName,Scope.SESSION);
    final String cookieName=request.getOptionalProperty("cookie",name);
    final String cookieValue=context.getCookie(cookieName);
    boolean hasObject;
    if (cookieValue != null) {
      try {
        context.getMappedObject(cookieValue);
        hasObject=true;
      }
 catch (      final ObjectNotFoundException e) {
        hasObject=false;
      }
    }
 else {
      hasObject=false;
    }
    if (hasObject) {
      request.skipUntilClose();
      context.addVariable(name,cookieValue,scope);
    }
 else {
      final String expiresString=request.getOptionalProperty("expires",SEVEN_DAYS);
      request.pushNewBuffer();
      request.processUtilCloseTag();
      request.popBuffer();
      final String id=(String)context.getVariable(RequestContext.RESULT);
      final ObjectAdapter variable=context.getMappedObject(id);
      if (variable != null) {
        context.addCookie(cookieName,id,Integer.valueOf(expiresString));
        context.addVariable(name,id,scope);
      }
    }
  }
}
