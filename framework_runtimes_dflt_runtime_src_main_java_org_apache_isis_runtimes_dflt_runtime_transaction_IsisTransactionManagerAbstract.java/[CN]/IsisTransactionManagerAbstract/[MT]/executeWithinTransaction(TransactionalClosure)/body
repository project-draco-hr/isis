{
  final boolean initiallyInTransaction=inTransaction();
  if (!initiallyInTransaction) {
    startTransaction();
  }
  try {
    closure.preExecute();
    closure.execute();
    closure.onSuccess();
    if (!initiallyInTransaction) {
      endTransaction();
    }
  }
 catch (  final RuntimeException ex) {
    closure.onFailure();
    if (!initiallyInTransaction) {
      try {
        abortTransaction();
      }
 catch (      final Exception e) {
        LOG.error("Abort failure after exception",e);
        throw new IsisTransactionManagerException("Abort failure: " + e.getMessage(),ex);
      }
    }
    throw ex;
  }
}
