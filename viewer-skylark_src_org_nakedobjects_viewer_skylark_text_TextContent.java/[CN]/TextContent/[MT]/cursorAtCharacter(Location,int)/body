{
  String text=getText(lineOffset);
  if (text == null) {
    for (int i=lineOffset; i >= 0; i--) {
      String text2=getText(i);
      if (text2 != null) {
        int at=text2.length();
        LOG.debug("Character at " + at + " line "+ lineOffset);
        return at;
      }
    }
  }
  int x=atLocation.getX() - 3;
  int at=0;
  int endAt=text.length();
  int width=0;
  while (at < endAt && x > width) {
    width+=target.getText().charWidth(text.charAt(at));
    at++;
  }
  LOG.debug("Character at " + at + " line "+ lineOffset);
  return at;
}
