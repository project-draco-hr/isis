{
  final DebugString debugText=new DebugString();
  final DebugHtmlString debugHtml=new DebugHtmlString();
  final DebugBuilder debug=new DebugTee(debugText,debugHtml);
  try {
    debug.startSection("Exception");
    debug.appendException(exception);
    debug.endSection();
  }
 catch (  final RuntimeException e) {
    debug.appendln("NOTE - an exception occurred while dumping an exception!");
    debug.appendException(e);
  }
  if (IsisContext.getCurrentTransaction() != null) {
    final List<String> messages=IsisContext.getMessageBroker().getMessages();
    final List<String> warnings=IsisContext.getMessageBroker().getWarnings();
    if (messages.size() > 0 || messages.size() > 0) {
      debug.startSection("Warnings/Messages");
      for (      final String message : messages) {
        debug.appendln("message",message);
      }
      for (      final String message : warnings) {
        debug.appendln("warning",message);
      }
    }
  }
  requestContext.append(debug);
  debug.startSection("Processing Trace");
  debug.appendPreformatted(requestContext.getDebugTrace());
  debug.endSection();
  debug.close();
  PrintWriter writer;
  try {
    final String directory=IsisContext.getConfiguration().getString(ConfigurationConstants.ROOT + "scimpi.error-snapshots",".");
    final File dir=new File(directory);
    if (!dir.exists()) {
      dir.mkdirs();
    }
    writer=new PrintWriter(new File(dir,"error_" + errorRef + ".html"));
    final DebugWriter writer2=new DebugWriter(writer,true);
    writer2.concat(debugHtml);
    writer2.close();
    writer.close();
  }
 catch (  final FileNotFoundException e) {
    LOG.error("Failed to archive error page",e);
  }
  final String replace="";
  final String withReplacement="";
  final String message=exception.getMessage();
  requestContext.addVariable("_error-message",message == null ? "" : message.replaceAll(replace,withReplacement),Scope.ERROR);
  requestContext.addVariable("_error-details",debugHtml.toString().replaceAll(replace,withReplacement),Scope.ERROR);
  requestContext.addVariable("_error-ref",errorRef,Scope.ERROR);
  requestContext.clearTransientVariables();
  final String msg="failed during request for " + servletPath;
  LOG.error(msg + " (#" + errorRef+ ")\n"+ message+ "\n"+ debugText+ "\n"+ msg);
}
