{
  RequestContext context=request.getContext();
  String objectId=request.getOptionalProperty(OBJECT);
  String forwardEditedTo=request.getOptionalProperty(VIEW);
  String forwardErrorTo=request.getOptionalProperty(ERRORS);
  boolean hideNonEditableFields=request.isRequested(HIDE_UNEDITABLE,false);
  boolean showIcon=request.isRequested(SHOW_ICON,true);
  String buttonTitle=request.getOptionalProperty(BUTTON_TITLE);
  String formTitle=request.getOptionalProperty(FORM_TITLE);
  String formId=request.getOptionalProperty(FORM_ID,request.nextFormId());
  String variable=request.getOptionalProperty(RESULT_NAME);
  String resultOverride=request.getOptionalProperty(RESULT_OVERRIDE);
  String scope=request.getOptionalProperty(SCOPE);
  String className=request.getOptionalProperty(CLASS,"edit full");
  String id=request.getOptionalProperty(ID);
  String completionMessage=request.getOptionalProperty(MESSAGE);
  final ObjectAdapter object=context.getMappedObjectOrResult(objectId);
  String actualObjectId=context.mapObject(object,Scope.INTERACTION);
  String version=context.mapVersion(object);
  final FormState entryState=(FormState)context.getVariable(ENTRY_FIELDS);
  final ObjectSpecification specification=object.getSpecification();
  FormFieldBlock containedBlock=new FormFieldBlock(){
    @Override public boolean isVisible(    String name){
      ObjectAssociation fld=specification.getAssociation(name);
      boolean isVisible=fld.isVisible(IsisContext.getAuthenticationSession(),object).isAllowed();
      boolean isUseable=fld.isUsable(IsisContext.getAuthenticationSession(),object).isAllowed();
      return isVisible && isUseable;
    }
    public ObjectAdapter getCurrent(    String name){
      ObjectAdapter value=null;
      if (entryState != null) {
        FieldEditState field2=entryState.getField(name);
        value=field2.getValue();
      }
      if (value == null) {
        ObjectAssociation fld=specification.getAssociation(name);
        value=fld.get(object);
      }
      return value;
    }
    public boolean isNullable(    String name){
      ObjectAssociation fld=specification.getAssociation(name);
      return !fld.isMandatory();
    }
  }
;
  request.setBlockContent(containedBlock);
  request.processUtilCloseTag();
  AuthenticationSession session=IsisContext.getAuthenticationSession();
  List<ObjectAssociation> viewFields=specification.getAssociations(ObjectAssociationFilters.dynamicallyVisible(session,object));
  viewFields=containedBlock.includedFields(viewFields);
  InputField[] formFields=createFields(viewFields);
  initializeFields(context,object,formFields,entryState,!hideNonEditableFields);
  setDefaults(context,object,formFields,entryState,showIcon);
  copyFieldContent(context,object,formFields,showIcon);
  overrideWithHtml(context,containedBlock,formFields);
  String errors=null;
  if (entryState != null && entryState.isForForm(formId)) {
    copyEntryState(context,object,formFields,entryState);
    errors=entryState.getError();
  }
  String errorView=context.fullFilePath(forwardErrorTo == null ? context.getResourceFile() : forwardErrorTo);
  List<HiddenInputField> hiddenFields=new ArrayList<HiddenInputField>();
  hiddenFields.add(new HiddenInputField("_" + OBJECT,actualObjectId));
  hiddenFields.add(new HiddenInputField("_" + VERSION,version));
  hiddenFields.add(new HiddenInputField("_" + FORM_ID,formId));
  hiddenFields.add(completionMessage == null ? null : new HiddenInputField("_" + MESSAGE,completionMessage));
  hiddenFields.add(forwardEditedTo == null ? null : new HiddenInputField("_" + VIEW,context.fullFilePath(forwardEditedTo)));
  hiddenFields.add(new HiddenInputField("_" + ERRORS,errorView));
  hiddenFields.add(variable == null ? null : new HiddenInputField("_" + RESULT_NAME,variable));
  hiddenFields.add(resultOverride == null ? null : new HiddenInputField("_" + RESULT_OVERRIDE,resultOverride));
  hiddenFields.add(scope == null ? null : new HiddenInputField("_" + SCOPE,scope));
  if (!object.isTransient()) {
    List<ObjectAssociation> fields2=object.getSpecification().getAssociations();
    for (int i=0; i < fields2.size(); i++) {
      ObjectAssociation field=fields2.get(i);
      if (!viewFields.contains(field) && field.getSpecification().containsFacet(BooleanValueFacet.class)) {
        String fieldId=field.getId();
        String value=getValue(context,field.get(object));
        hiddenFields.add(new HiddenInputField(fieldId,value));
      }
    }
  }
  if (formTitle == null) {
    formTitle=specification.getSingularName();
  }
  if (buttonTitle == null) {
    buttonTitle="Save " + specification.getSingularName();
  }
 else   if (buttonTitle.equals("")) {
    buttonTitle="Save";
  }
  HiddenInputField[] hiddenFieldArray=hiddenFields.toArray(new HiddenInputField[hiddenFields.size()]);
  HtmlFormBuilder.createForm(request,EditAction.ACTION + ".app",hiddenFieldArray,formFields,className,id,formTitle,null,null,buttonTitle,errors);
  request.popBlockContent();
}
