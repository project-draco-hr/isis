{
  if (applicationComponents == null || applicationComponents.isStale()) {
    final IsisConfiguration jdoObjectstoreConfig=configuration.createSubset(DataNucleusPersistenceMechanismInstaller.JDO_OBJECTSTORE_CONFIG_PREFIX);
    final IsisConfiguration dataNucleusConfig=configuration.createSubset(DataNucleusPersistenceMechanismInstaller.DATANUCLEUS_CONFIG_PREFIX);
    final Map<String,String> datanucleusProps=dataNucleusConfig.asMap();
    addDataNucleusPropertiesIfRequired(datanucleusProps);
    final RegisterEntities registerEntities=new RegisterEntities(configuration.asMap());
    final Set<String> classesToBePersisted=registerEntities.getEntityTypes();
    applicationComponents=new DataNucleusApplicationComponents(jdoObjectstoreConfig,datanucleusProps,classesToBePersisted);
  }
  return applicationComponents;
}
