{
  if (object == null) {
    return null;
  }
  Oid oid=object.getOid();
  NakedObjectSpecification specification=object.getSpecification();
  String type=specification.getFullName();
  ResolveState resolveState=object.getResolveState();
  if (resolveState.isSerializing()) {
    return createObjectData(oid,type,null,resolveState.isResolved(),object.getVersion());
  }
  NakedObjects.getObjectLoader().start(object,object.getResolveState().serializeFrom());
  NakedObjectField[] fields=specification.getFields();
  Object[] fieldContent=new Object[fields.length];
  for (int i=0; i < fields.length; i++) {
    Naked field=object.getField(fields[i]);
    if (field == null) {
      continue;
    }
 else     if (fields[i].isValue()) {
      fieldContent[i]=field.getObject();
    }
 else     if (fields[i].isCollection()) {
      fieldContent[i]=createCollectionData((NakedCollection)field,depth - 1);
    }
 else {
      fieldContent[i]=createObjectData((NakedObject)field,depth - 1);
    }
  }
  NakedObjects.getObjectLoader().end(object);
  return createObjectData(oid,type,fieldContent,resolveState.isResolved(),object.getVersion());
}
