{
  if (object == null) {
    return null;
  }
  Oid oid=object.getOid();
  NakedObjectSpecification specification=object.getSpecification();
  String type=specification.getFullName();
  if (savedObjects.contains(object) || (depth <= 0 && object.isPersistent())) {
    return createObjectData(oid,type,null,object.isResolved(),object.getVersion());
  }
  savedObjects.addElement(object);
  NakedObjectField[] fields=specification.getFields();
  Object[] fieldContent=new Object[fields.length];
  for (int i=0; i < fields.length; i++) {
    Naked field=object.getField(fields[i]);
    if (field == null) {
      continue;
    }
    if (fields[i].isValue()) {
      fieldContent[i]=field.getObject();
    }
 else     if (fields[i].isCollection()) {
      fieldContent[i]=createCollectionData((NakedCollection)field,savedObjects,depth - 1);
    }
 else {
      fieldContent[i]=createObjectData((NakedObject)field,savedObjects,depth - 1);
    }
  }
  return createObjectData(oid,type,fieldContent,object.isResolved(),object.getVersion());
}
