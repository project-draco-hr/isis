{
  Object oid=object.getOid();
  if (oid != null && !oid.equals(state.oid)) {
    throw new IllegalArgumentException("This memento can only be used to " + "update the naked object with the Oid " + state.oid);
  }
 else {
    if (!(state instanceof ObjectData)) {
      throw new NakedObjectRuntimeException("Expected an ObjectData but got " + state.getClass());
    }
 else {
      ObjectData od=(ObjectData)state;
      FieldSpecification[] fields=object.getSpecification().getFields();
      for (int i=0; i < fields.length; i++) {
        FieldSpecification field=fields[i];
        Object fieldData=od.getEntry(field.getName());
        if (!field.isDerived()) {
          if (field instanceof ValueFieldSpecification) {
            updateValue(object,field,(String)fieldData);
          }
 else           if (field instanceof OneToManyAssociationSpecification) {
            updateOneToManyAssociation(object,loadedObjects,(OneToManyAssociationSpecification)field,(InternalCollectionData)fieldData,context);
          }
 else           if (field instanceof OneToOneAssociationSpecification) {
            updateOneToOneAssociation(object,loadedObjects,(OneToOneAssociationSpecification)field,(Data)fieldData,context);
          }
        }
      }
    }
    LOG.debug("object updated " + object.getOid());
  }
}
