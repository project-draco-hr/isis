{
  if (applicationComponents != null) {
    return;
  }
  final IsisConfiguration dataNucleusConfig=configuration.createSubset(ISIS_CONFIG_PREFIX);
  final Map<String,String> props=dataNucleusConfig.asMap();
  addDataNucleusPropertiesIfRequired(props);
  final String pmfClassName=props.get(JAVAX_JDO_PERSISTENCE_MANAGER_FACTORY_CLASS);
  if (!PERSISTENCE_MANAGER_FACTORY_CLASS_FOR_ISIS.equals(pmfClassName)) {
    throw new IllegalArgumentException(JAVAX_JDO_PERSISTENCE_MANAGER_FACTORY_CLASS + " must be set to " + PERSISTENCE_MANAGER_FACTORY_CLASS_FOR_ISIS);
  }
  applicationComponents=new DataNucleusApplicationComponents(props,getSpecificationLoader().allSpecifications());
}
