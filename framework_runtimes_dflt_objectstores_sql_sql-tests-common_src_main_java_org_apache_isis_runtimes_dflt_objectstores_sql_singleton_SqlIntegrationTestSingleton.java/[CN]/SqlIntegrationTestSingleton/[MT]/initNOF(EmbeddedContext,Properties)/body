{
  final IsisConfigurationDefault configuration=new IsisConfigurationDefault();
  configuration.add(properties);
  persistorName=configuration.getString("isis.persistor");
  sqlDataClassFactory=new SqlDataClassFactory();
  if (system != null) {
    system.closeSession();
  }
  final IsisMetaModel isisMetaModel=new IsisMetaModel(embeddedContext,sqlDataClassFactory);
  isisMetaModel.setConfiguration(configuration);
  system=new TestSystem(isisMetaModel);
  final ObjectStorePersistenceMechanismInstallerAbstract persistorInstaller=createPersistorInstaller(configuration);
  system.openSession(null,persistorInstaller);
  resetPersistorState(configuration);
}
