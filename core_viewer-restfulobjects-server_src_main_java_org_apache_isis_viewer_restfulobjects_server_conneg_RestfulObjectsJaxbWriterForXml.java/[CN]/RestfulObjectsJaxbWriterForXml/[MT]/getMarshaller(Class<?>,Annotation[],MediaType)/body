{
  final Marshaller marshaller=super.getMarshaller(type,annotations,mediaType);
  marshaller.setAdapter(PersistentEntityAdapter.class,new PersistentEntityAdapter(){
    @Override protected BookmarkService getBookmarkService(){
      final PersistenceSession persistenceSession=IsisContext.getSessionFactory().getCurrentSession().getPersistenceSession();
      final ServicesInjector servicesInjector=persistenceSession.getServicesInjector();
      return servicesInjector.lookupService(BookmarkService.class);
    }
  }
);
  return marshaller;
}
