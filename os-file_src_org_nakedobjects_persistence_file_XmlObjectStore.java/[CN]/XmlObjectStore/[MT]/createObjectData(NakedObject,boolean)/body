{
  LOG.debug("compiling object data for " + object);
  ObjectData data;
  data=new ObjectData(object.getSpecification(),(SerialOid)object.getOid());
  NakedObjectField[] fields=object.getSpecification().getFields();
  for (int i=0; i < fields.length; i++) {
    if (fields[i].isDerived()) {
      continue;
    }
    Naked field=object.getField(fields[i]);
    Naked fieldContent=field;
    String fieldName=fields[i].getName();
    if (fieldContent instanceof InternalCollection) {
      data.addInternalCollection((InternalCollection)fieldContent,fieldName,ensurePersistent);
    }
 else     if (fields[i].isValue()) {
      data.saveValue(fieldName,object.isEmpty(fields[i]),field == null ? null : field.getObject().toString());
    }
 else {
      data.addAssociation((NakedObject)fieldContent,fieldName,ensurePersistent);
    }
  }
  return data;
}
